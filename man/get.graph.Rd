% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/lm.graph.embed.R
\name{get.graph}
\alias{get.graph}
\title{Graph embedding of landmarks}
\usage{
get.graph(
  .lm.obj,
  .k = 20,
  .scale = if (.lm.obj$assay.type == "RNA") FALSE else TRUE,
  .verbose = TRUE,
  .seed = 123,
  .cl.method = "snn",
  .cl.resolution.parameter = 0.8,
  .small.size = floor(x = nrow(x = .lm.obj$lm)/200)
)
}
\arguments{
\item{.lm.obj}{A tinydenseR object initialized with \code{setup.lm.obj} and processed with
\code{get.landmarks}.}

\item{.k}{Integer number of nearest neighbors for graph construction (default 20). Higher values
create more connected graphs and smoother UMAP embeddings. Used for k-NN graph construction
and passed to \code{uwot::umap} as \code{n_neighbors}.}

\item{.scale}{Logical indicating whether to scale features before UMAP. Defaults to FALSE for
RNA assays (PCA already scaled) and TRUE for cytometry.}

\item{.verbose}{Logical for progress messages (default TRUE).}

\item{.seed}{Integer seed for reproducibility of UMAP and clustering (default 123).}

\item{.cl.method}{Character specifying clustering method: "snn" (shared nearest neighbors via
Jaccard similarity) or "fgraph" (fuzzy graph from UMAP). Default "snn".}

\item{.cl.resolution.parameter}{Numeric controlling cluster granularity (default 0.8). Higher
values produce more fine-grained clusters.}

\item{.small.size}{Integer threshold for straggler clusters (default 0.5\% of landmarks). Clusters
smaller than this are absorbed into nearest large cluster.}
}
\value{
Updated \code{.lm.obj} with \code{$graph} component containing:
\itemize{
\item \code{uwot}: UMAP model with multiple components:
\itemize{
\item \code{$embedding}: 2D UMAP coordinates for visualization
\item \code{$nn$euclidean$idx}: k-NN indices matrix (landmarks Ã— k neighbors)
\item \code{$nn$euclidean$dist}: k-NN distance matrix
\item \code{$fgraph}: Fuzzy graph (landmark-landmark probabilistic edges) for optional clustering
\item \code{$model}: Trained UMAP model for projecting query cells in \code{get.map}
}
\item \code{adj.matrix}: Sparse k-NN adjacency matrix (non-symmetric).
\item \code{snn}: Shared nearest neighbor graph via Jaccard similarity.
\item \code{LE}: Laplacian Eigenmap components computed from symmetrized k-NN graph, including
\code{$W.sym} (symmetrized adjacency), \code{$L} (Laplacian), \code{$Disqrt} (degree matrix),
\code{$vectors}, \code{$values}, \code{$converged}, \code{$nontriv} (non-trivial eigenvalue indices),
\code{$elbow} (selected dimensionality), \code{$keep} (retained eigenvectors), and \code{$embed}
(final normalized embedding). Used for clustering initialization only.
\item \code{clustering}: List containing \code{$ids} (factor of cluster assignments), \code{$median.exprs}
(matrix of mean expression per cluster), and \code{$pheatmap} (heatmap object).
}
}
\description{
Builds k-NN graph and trains UMAP model for landmark cells. This creates the graph structure
and transformation model required for generating fuzzy density matrices in \code{get.map}.
Clustering is performed as a secondary step for visualization and interpretation, but is not
the primary objective.
}
\details{
The function orchestrates graph-based analysis in the following order:

\strong{1. k-NN Graph Construction:}
Builds k-nearest neighbor graph from PCA/Harmony embeddings and converts it to multiple
representations for different downstream applications:
\itemize{
\item \code{adj.matrix}: Non-symmetric sparse adjacency matrix (used to compute SNN graph)
\item \code{snn}: Shared nearest neighbor graph via Jaccard similarity (used for clustering)
\item \code{W.sym}: Symmetrized binary adjacency (used for Laplacian Eigenmap spectral analysis)
}

\strong{2. UMAP Model Training:}
Trains UMAP transformation on landmark cells with \code{ret_model=TRUE} to enable projection of
query cells later. The UMAP model includes the fuzzy graph (landmark-landmark probabilistic edges) which
is used for optional clustering and, after projection in \code{get.map}, generates cell-landmark
edge weights essential for computing fuzzy density matrices. The UMAP model is the primary output
of \code{get.graph}.

\strong{3. Laplacian Eigenmap (LE):}
Computes spectral embedding by solving the generalized eigenvalue problem of the graph Laplacian.
Dimensionality is automatically selected via elbow detection on eigenvalue spectrum. The LE
embedding is currently used only for warm-start initialization in clustering.

\strong{4. Clustering (Secondary):}
Applies Leiden algorithm to identify communities for visualization and interpretation. Uses SNN
graph (Jaccard similarity) or UMAP fuzzy graph depending on \code{.cl.method}. Small "straggler"
clusters are absorbed into neighbors. While useful for exploration, clustering is not required
for downstream statistical analysis, unless traditional analysis is requested later in \code{get.stats}.
}
\examples{
\dontrun{
# Typical workflow after landmark selection
lm.cells <- setup.lm.obj(.cells = .cells, 
                          .meta = .meta,
                          .assay.type = "RNA") |>
  get.landmarks(.nHVG = 500, .nPC = 3) |>
  get.graph(.k = 10)

# Higher resolution for finer clusters
lm.cells <- setup.lm.obj(.cells = .cells, .meta = .meta) |>
  get.landmarks() |>
  get.graph(.cl.resolution.parameter = 200)

# Use fuzzy graph for clustering instead of SNN
lm.cells <- get.graph(lm.cells, .cl.method = "fgraph")
}

}
\seealso{
\code{\link{setup.lm.obj}}, \code{\link{get.landmarks}}, \code{\link{lm.cluster}}
}
