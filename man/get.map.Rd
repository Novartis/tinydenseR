% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/lm.graph.embed.R
\name{get.map}
\alias{get.map}
\title{Mapping cells to landmarks}
\usage{
get.map(
  .lm.obj,
  .ref.obj = NULL,
  .integrate.vars = NULL,
  .celltype.col.name = "cell_type",
  .cl.ct.to.ign = NULL,
  .irrel.par = NULL,
  .verbose = TRUE,
  .seed = 123
)
}
\arguments{
\item{.lm.obj}{A tinydenseR object with \code{$graph} component populated by \code{get.graph}.}

\item{.ref.obj}{Optional Symphony reference object for cell type annotation. Must have
\code{Z_corr} field (harmony-corrected embeddings) and metadata with cell type labels.
Only compatible with RNA assays. Replaces any existing \code{$graph$celltyping}.}

\item{.integrate.vars}{Character vector of batch variables for integration (metadata columns).
Currently not used in function body.}

\item{.celltype.col.name}{Column name in \code{.ref.obj$meta_data} containing cell type labels
(default "cell_type"). Only relevant when \code{.ref.obj} is provided.}

\item{.cl.ct.to.ign}{Optional cluster or cell type name to exclude from downstream statistics.
Use for biologically irrelevant populations (e.g., erythrocytes in PBMC, which likely
represent technical artifacts). Cells in this population are mapped but excluded from density
calculations. Only one value allowed; merge multiple populations first via \code{celltyping}.}

\item{.irrel.par}{Character vector of irrelevant parameters to exclude. Currently not used.}

\item{.verbose}{Logical for progress messages (default TRUE).}

\item{.seed}{Integer seed for reproducibility (default 123).}
}
\value{
Updated \code{.lm.obj} with \code{$map} component containing:
\itemize{
\item \code{fdens}: Matrix of fuzzy graph densities (landmarks Ã— samples). Each entry is
the sum of cell-landmark edge weights for that sample, excluding ignored populations.
\item \code{cell.clustering}: Named vector of cluster assignments for all cells.
\item \code{cell.celltyping}: Named vector of cell type assignments (if celltyping available).
\item \code{nn.idx}: Nearest landmark indices for all cells.
}
If \code{.ref.obj} provided, also updates \code{$graph$celltyping} with reference-based labels.
}
\description{
Projects all cells onto the landmark graph to compute probabilities of cell-landmark neighborhood.
In addition, transfers cluster/cell type labels from landmarks to all cells.
}
\details{
\strong{Workflow Overview:}

For each sample, the function:
\enumerate{
\item Loads expression data and normalizes (size factors for RNA, marker subset for cytometry)
\item Projects to PCA/Harmony space (matching landmark processing)
\item Transforms to UMAP coordinates using the landmark UMAP model
\item Assigns clusters/cell types by nearest landmark
\item Computes fuzzy graph densities (cell-landmark edge weights)
}

\strong{Reference-Based Cell Typing:}

When \code{.ref.obj} is provided:
\itemize{
\item Expression is mapped to reference via Symphony
\item Cell types assigned by nearest neighbor in reference embedding
\item Landmark cell types updated and used for visualization/statistics
\item Replaces any existing manual cell type annotations
}

\strong{Fuzzy Graph Densities:}

The \code{fdens} matrix quantifies how strongly each landmark is connected to cells in each
sample. High values indicate the landmark's neighborhood is enriched in that sample. This
forms the basis for differential abundance testing in \code{get.stats}.
}
\examples{
\dontrun{
# Complete workflow with mapping
lm.cells <- setup.lm.obj(.cells = .cells, .meta = .meta) |>
  get.landmarks(.nHVG = 500) |>
  get.graph() |>
  get.map()

# Exclude erythrocytes from PBMC statistics
lm.cells <- get.map(lm.cells, .cl.ct.to.ign = "Erythrocytes")

# Use Symphony reference for cell typing (RNA data only)
ref <- readRDS("pbmc_reference.rds")
lm.cells <- get.map(lm.cells, 
                    .ref.obj = ref, 
                    .celltype.col.name = "cell_type")
}

}
\seealso{
\code{\link{get.graph}}, \code{\link{get.stats}}, \code{\link{celltyping}}
}
